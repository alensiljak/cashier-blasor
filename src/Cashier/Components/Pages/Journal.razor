@page "/journal"
@using MudBlazor

@inject IDexieDAL _db
@inject NavigationManager NavMan
@inject AppState State
@inject IDialogService DialogService
@inject NotificationService Notification

<ToolbarMud>
    <Title>
        Journal
    </Title>
    <ContextMenuItems>
        <MudListItem Icon="@IconsMud.FileDown" @onclick="OnExportClick">Export</MudListItem>
        <MudListItem Icon="@IconsMud.Trash" OnClick="onDeleteAllClicked">Delete All</MudListItem>
    </ContextMenuItems>
</ToolbarMud>

<MudList>
    @foreach (var xact in _xacts)
    {
        <MudListItem>
            <JournalTransactionRow Xact="@xact" OnItemClicked="@OnItemClicked" />
        </MudListItem>
    }
</MudList>

<MudFab Class="z-60" Color="Color.Tertiary" IconColor="Color.Secondary" StartIcon="@IconsMud.Plus"
        Style="@Constants.DefaultFabPosition" @onclick="OnFab" />

@code {
    List<Xact> _xacts = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await loadData();
    }

    private async Task loadData()
    {
        _xacts = await _db.Xacts.ToList();
    }

    async Task onDeleteAllClicked()
    {
        State.CloseMenu();

        // confirm with a dialog
        var parameters = new DialogParameters<ConfirmationDialog>();
        parameters.Add(x => x.ContentText, "Do you want to delete all the Transactions?");
        parameters.Add(x => x.ConfirmationButtonColor, Color.Secondary);
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Confirm Delete", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Large });
        var result = await dialog.Result;
        if (result.Canceled) return;

        // delete all transactions
        await _db.Xacts.Clear();

        Notification.Success("All local transactions deleted.");

        await loadData();
    }

    void OnExportClick()
    {
        State.CloseMenu();

        NavMan.NavigateTo("/export");
    }

    void OnFab()
    {
        // create new transaction in the app store
        var xact = new TransactionActions().CreateNew();
        State.Xact = xact;

        NavMan.NavigateTo("/tx");
    }

    void OnItemClicked(Xact xact)
    {
        // Here we set the selected Transaction as the current transaction.
        State.Xact = xact;

        NavMan.NavigateTo("/xact-actions");
    }
}
