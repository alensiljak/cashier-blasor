@page "/asset-allocation"

@using KristofferStrube.Blazor.FileSystem
@using MudBlazor

@inject IDexieDAL _db
@inject ISettingsService settings
@inject IStorageManagerService StorageManagerService
@inject NotificationService Notification
@inject NavigationManager NavMan
@inject AppState _state

<ToolbarMud>
    <Title>Asset Allocation</Title>
    <ContextMenuItems>
        <MudListItem Icon="@IconsMud.DatabaseZap" @onclick="OnClearCacheClick">Clear cache</MudListItem>
    </ContextMenuItems>
</ToolbarMud>

<MudContainer Style="max-width: 660px;" Class="pa-0 mb-2">
    <MudSimpleTable Dense Style="background-color: transparent;">
        <thead>
            <tr>
                <th colspan="1"></th>
                <th colspan="4" style="text-align: center; border-right-width: 1px;">Allocation</th>
                <th colspan="3" style="text-align: center;">Value</th>
            </tr>
            <tr>
                <th style="text-align: center;">Asset Class</th>
                <th style="text-align: center;">Target</th>
                <th style="text-align: center;">Current</th>
                @* <th style="text-align: center;">Diff</th> *@
                <th style="text-align: center;">Diff %</th>
                <th style="text-align: center;">Allocated</th>
                <th style="text-align: center;">Current</th>
                <th style="text-align: center;">Difference</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in allocation)
            {
                <tr>
                    <td>
                        <MudLink Class="@(string.Format("pl-{0}", ((item.Depth - 1) * 3)))"
                                 Color="Color.Surface" @onclick="@(() => ShowDetails(item.FullName))">@item.Name</MudLink>
                    </td>
                    <td style="text-align: end;">
                        <MudText>
                            @item.Allocation.ToString(NUMBER)
                        </MudText>
                    </td>
                    <td style="text-align: end;">
                        <MudText>
                            @item.CurrentAllocation.ToString(NUMBER)
                        </MudText>
                    </td>
                    @* <td style="text-align: end;">
                @item.Diff.ToString(NUMBER)
                </td>*@
                    @* Diff % *@
                    <td style="text-align: end; color: @GetColor(item.DiffPerc);">
                        <MudText>
                            @item.DiffPerc.ToString(NUMBER)
                        </MudText>
                    </td>
                    <td style="text-align: end;">
                        <MudText>
                            @item.AllocatedValue.ToString(NUMBER)
                        </MudText>
                    </td>
                    <td style="text-align: end;">
                        <MudText>
                            @item.CurrentValue.Quantity?.ToString(NUMBER)
                        </MudText>
                    </td>
                    <td style="text-align: end; color: @GetColor(item.DiffPerc);">
                        <MudText>
                            @item.DiffAmount.ToString(NUMBER)
                        </MudText>
                    </td>
                </tr>
            }
        </tbody>
    </MudSimpleTable>
</MudContainer>

<style>
    .mud-simple-table table * tr td {
        padding: 1px 4px !important;
    }
</style>

@code {
    const string NUMBER = "#,##0.00";
    // string? content;
    List<AssetClass> _allocation = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await loadData();
    }

    async Task loadData()
    {
        // Use cached AA, if available
        if (_state.AssetAllocation != null)
        {
            _allocation = _state.AssetAllocation;
        }
        else
        {
            _allocation = await LoadAaFromFile();

            // Cache the asset allocation for Asset Class details, etc.
            _state.AssetAllocation = _allocation;
        }

        // text output
        // TODO: content = aa.GetTextReport();
    }

    async Task<List<AssetClass>> LoadAaFromFile()
    {
        // load aa
        var opfs = new OpfsService(StorageManagerService);
        var definition = await opfs.ReadFromFile(Constants.AssetAllocationFilename);
        var accountService = new AccountService();

        var aa = new AssetAllocationService(settings, _db, accountService);
        try
        {
            await aa.loadFullAssetAllocation(definition);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.ToString());
            Notification.Error(ex.Message);
        }

        return aa.classes;
    }

    /// <summary>
    /// Colors and shades for the text based on the value.
    /// </summary>
    /// <param name="value"></param>
    /// <returns></returns>
    string GetColor(decimal value)
    {
        switch (value)
        {
            case var n when n <= -20:
                return Colors.Red.Darken4;

            case var n when -20 < n && n < 0:
                return Colors.Red.Lighten3;

            case var n when 0 < n && n < 20:
                return Colors.Green.Lighten3;

            case var n when n > 20:
                return Colors.Green.Darken3;
        }

        return string.Empty;
    }

    async Task OnClearCacheClick()
    {
        _state.AssetAllocation = null;

        await loadData();
    }

    void ShowDetails(string fullName)
    {
        NavMan.NavigateTo("/assetclassdetail/" + fullName);
    }
}
